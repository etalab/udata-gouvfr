{% extends 'dataset/display.html' %}

{% set community_subtitle = _('Explore with %(certifier)s', certifier=config.SITE_TITLE ) %}

{% block left_column_bottom %}
<!-- dataset recommendations -->
<script src="https://cdn.polyfill.io/v2/polyfill.js?features=fetch"></script>
<script type="text/javascript">
var recoUrl = 'https://raw.githubusercontent.com/etalab/datasets_reco/master/reco_json/';

function getDatasetId() {
    var selector = '#json_ld';
    var dataset = JSON.parse(document.querySelector(selector).text);
    return dataset && dataset['@id'];
}

function addRecos(recos) {
    var maxRecos = 2;
    var recoContainer = document.getElementById('dataset-recommendations-container');
    var recoChildContainer, recoChildEmbed;
    recos.splice(0, maxRecos).forEach(function (reco) {
        recoChildContainer = document.createElement('div');
        recoChildContainer.classList.add('col-reco', 'col-sm-12', 'col-md-6');
        recoChildEmbed = document.createElement('div');
        recoChildEmbed.setAttribute('data-udata-dataset-id', reco[0]);
        recoChildContainer.appendChild(recoChildEmbed);
        recoContainer.appendChild(recoChildContainer);
    });
}

function addWidgetScript() {
    var scriptElm = document.createElement('script');
    scriptElm.type = 'application/javascript';
    scriptElm.src = '/static/widgets.js';
    scriptElm.id = 'udata';
    scriptElm.onload = loadDatasets;
    document.body.appendChild(scriptElm);
}

function loadDatasets() {
    udataScript.loadDatasets();
}

function fetchRecos(datasetId) {
    fetch(recoUrl + datasetId + '.json').then(function (response) {
        if(response.ok) {
            return response.json();
        }
    }).then(function (recos) {
        recos = recos && recos[datasetId];
        if (recos) {
            addRecos(recos);
            addWidgetScript();
            var recoParent = document.getElementById('dataset-recommendations');
            recoParent.style.display = 'block';
        }
    });
}

var datasetId = getDatasetId();
if (datasetId) {
    // TODO remove me
    // * 1 dataset
    // datasetId = '53698e90a3a729239d2034d3';
    // * 2 datasets
    // datasetId = '536991b0a3a729239d203d13'
    fetchRecos(datasetId);
}
</script>
<div id="dataset-recommendations" class="hidden-xs">
    <h3>See also</h3>
    <div id="dataset-recommendations-container"></div>
</div>
{% endblock %}
